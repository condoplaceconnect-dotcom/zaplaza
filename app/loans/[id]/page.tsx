\'use client\';\n\nimport { useEffect, useState } from \'react\';\nimport { useParams, useRouter } from \'next/navigation\';\nimport { loanSDK } from \'@/lib/loanSDK\';\nimport { useAuth } from \'@/hooks/AuthContext\';\nimport { Loan } from \'@shared/schema\';\n\n// A simple modal component for capturing condition notes\nconst ConditionNotesModal = ({ isOpen, onClose, onSubmit, title }: any) => {\n    const [notes, setNotes] = useState(\'\');\n    if (!isOpen) return null;\n\n    return (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center\">\n            <div className=\"bg-white p-6 rounded-lg shadow-xl max-w-sm w-full\">\n                <h2 className=\"text-xl font-bold mb-4\">{title}</h2>\n                <textarea\n                    value={notes}\n                    onChange={(e) => setNotes(e.target.value)}\n                    placeholder=\'Ex: O item possui um pequeno arranhão na lateral direita.\'\n                    className=\"w-full p-2 border rounded-md mb-4 h-28\"\n                />\n                <div className=\"flex justify-end space-x-2\">\n                    <button onClick={onClose} className=\"px-4 py-2 rounded-md text-gray-600 bg-gray-100 hover:bg-gray-200\">Cancelar</button>\n                    <button onClick={() => onSubmit(notes)} className=\"px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700\">Confirmar</button>\n                </div>\n            </div>\n        </div>\n    );\n};\n\nexport default function LoanDetailsPage() {\n    const { id } = useParams();\n    const { user, isLoading: authLoading } = useAuth();\n    const [loan, setLoan] = useState<any | null>(null);\n    const [isLoading, setIsLoading] = useState(true);\n    const [error, setError] = useState<string | null>(null);\n    const [modal, setModal] = useState({ isOpen: false, action: null });\n\n    const fetchLoan = async () => {\n        try {\n            const loanDetails = await loanSDK.agreements.getDetails(id as string);\n            setLoan(loanDetails);\n        } catch (err: any) {\n            setError(err.message);\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    useEffect(() => {\n        if (!authLoading && id) {\n            fetchLoan();\n        }\n    }, [id, authLoading]);\n
    const handleAction = async (action: Function, payload?: any) => {\n        setError(null);\n        try {\n            await action(id, payload);\n            await fetchLoan(); // Refresh data\n        } catch (err: any) {\n            setError(err.message);\n        }\n        setModal({ isOpen: false, action: null });\n    };\n
    if (isLoading || authLoading) return <div>Carregando...</div>;\n    if (error) return <div>Erro: {error}</div>;\n    if (!loan) return <div>Empréstimo não encontrado.</div>;\n
    const isOwner = user?.id === loan.owner.id;\n    const isBorrower = user?.id === loan.borrower.id;\n
    const openModal = (action: any) => setModal({ isOpen: true, action: action });\n
    return (\n        <div className=\"container mx-auto p-4 max-w-3xl\">\n            <h1 className=\"text-3xl font-bold font-poppins mb-2\">Detalhes do Empréstimo</h1>\n            <p className=\"text-lg text-gray-600 mb-6\">Item: {loan.request.itemName}</p>\n
            {/* Loan Status & Actions */}\n            <div className=\"bg-white p-6 rounded-lg border shadow-sm space-y-4\">\n                 <div className=\"flex justify-between items-center\">\n                    <span className=\"font-semibold text-gray-700\">Status:</span>\n                    <span className=\"px-3 py-1 text-sm font-bold text-white bg-blue-500 rounded-full\">{loan.status}</span>\n                </div>\n                \n                {/* ACTION BUTTONS based on status and user role */}\n                {loan.status === \'active\' && isOwner && (\n                    <button onClick={() => openModal(loanSDK.agreements.confirmHandover)} className=\"w-full py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700\">Confirmar Entrega do Item</button>\n                )}\n                {loan.status === \'in_progress\' && isBorrower && (\n                    <button onClick={() => openModal(loanSDK.agreements.initiateReturn)} className=\"w-full py-2 font-bold text-white bg-orange-500 rounded-lg hover:bg-orange-600\">Iniciar Devolução</button>\n                )}\n                {loan.status === \'return_initiated\' && isOwner && (\n                     <button onClick={() => handleAction(loanSDK.agreements.confirmReturnByOwner)} className=\"w-full py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700\">Confirmar Recebimento da Devolução</button>\n                )}\n                {loan.status === \'completed\' && (\n                     <p className=\"text-center text-green-600 font-semibold\">Este empréstimo foi concluído com sucesso!</p>\n                )}\n            </div>\n
            {/* Digital Term */}\n             <div className=\"mt-6\">\n                <h3 className=\"text-xl font-semibold mb-2\">Termo de Responsabilidade</h3>\n                <div className=\"p-4 bg-gray-50 border rounded-md text-sm text-gray-600\">\n                    <p>{loan.digitalTerm}</p>\n                </div>\n            </div>\n
            {/* Condition History */}\n            <div className=\"mt-6\">\n                <h3 className=\"text-xl font-semibold mb-2\">Histórico de Condições</h3>\n                <div className=\"space-y-4\">\n                    <div className=\"p-4 bg-white border rounded-md\">\n                        <p className=\"font-bold\">Na entrega:</p>\n                        <p className=\"text-sm text-gray-700\">{loan.handoverConditionNotes || \'Nenhuma nota adicionada.\'}</p>\n                    </div>\n                    <div className=\"p-4 bg-white border rounded-md\">\n                        <p className=\"font-bold\">Na devolução:</p>\n                        <p className=\"text-sm text-gray-700\">{loan.returnConditionNotes || \'Nenhuma nota adicionada ainda.\'}</p>\n                    </div>\n                </div>\n            </div>\n
            {/* Modal for condition notes */}\n            <ConditionNotesModal\n                isOpen={modal.isOpen}\n                onClose={() => setModal({ isOpen: false, action: null })}\n                onSubmit={(notes: string) => handleAction(modal.action, { conditionNotes: notes }) }\n                title={\"Registrar Condição do Item\"}\n            />\n        </div>\n    );\n}\n